<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- (تعديل) العنوان -->
    <title>متتبع تمارين | Omar Abdelbaky</title>
    
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- تحميل Chart.js (للرسم البياني) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- تحميل أيقونات (Heroicons) -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

    <style>
        /* استخدام خط Inter الافتراضي من Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* gray-900 */
            color: #f3f4f6; /* gray-100 */
        }
        
        /* تصميم خلفية جذابة */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.15;
            background-image: radial-gradient(circle at 1px 1px, #4b5563, transparent 1px); /* gray-600 */
            background-size: 1.5rem 1.5rem;
        }

        .card {
            background-color: #1f2937; /* gray-800 */
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid #374151; /* gray-700 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            overflow: hidden;
        }

        .tab-button {
            padding: 0.75rem 1rem;
            font-weight: 600;
            border-radius: 0.5rem; /* rounded-lg */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
        }

        .tab-button.active {
            background-color: #3b82f6; /* blue-600 */
            color: white;
        }

        .tab-button:not(.active) {
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
        }
        
        .tab-button:not(.active):hover {
            background-color: #4b5563; /* gray-600 */
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-input {
            background-color: #374151; /* gray-700 */
            border: 1px solid #4b5563; /* gray-600 */
            color: white;
            border-radius: 0.375rem; /* rounded-md */
            text-align: center;
            padding: 0.5rem;
            width: 5rem; /* w-20 */
        }
        
        .form-input::placeholder {
            color: #9ca3af; /* gray-400 */
        }

        .log-button {
            background-color: #16a34a; /* green-600 */
            color: white;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s;
        }
        
        .log-button:hover {
            background-color: #15803d; /* green-700 */
        }
        
        /* (جديد) زر نصائح الذكاء الاصطناعي */
        .ai-tips-btn {
            background-color: #7c3aed; /* violet-600 */
            color: white;
            font-weight: 500;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s;
            font-size: 0.875rem; /* text-sm */
        }
        .ai-tips-btn:hover {
            background-color: #6d28d9; /* violet-700 */
        }
        
        /* (جديد) زر إحماء الذكاء الاصطناعي */
        .ai-warmup-btn {
            background-color: #9333ea; /* purple-600 */
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem; /* rounded-lg */
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
        }
        .ai-warmup-btn:hover {
            background-color: #7e22ce; /* purple-700 */
        }

        
        /* شاشة تحميل بسيطة جداً */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #111827; /* gray-900 */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        
        .spinner {
            width: 3rem; /* w-12 */
            height: 3rem; /* h-12 */
            border: 4px solid #4b5563; /* border-gray-600 */
            border-top-color: #3b82f6; /* border-t-blue-600 */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }


        /* رسالة التنبيه (Toast) */
        #toast {
            position: fixed;
            bottom: -100px; /* ابدأ من خارج الشاشة */
            left: 50%;
            transform: translateX(-50%);
            background-color: #16a34a; /* green-600 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: bottom 0.5s ease-in-out;
            z-index: 1000;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* (جديد) تنسيقات نافذة الـ Modal الخاصة بـ Gemini */
        #ai-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5000;
            padding: 1rem;
        }
        
        #ai-modal .card {
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        #ai-modal-content {
            overflow-y: auto;
            min-height: 100px; /* لإظهار السبينر */
            display: flex;
            justify-content: center;
            align-items: center;
            white-space: pre-wrap; /* للحفاظ على تنسيق النص من Gemini */
            line-height: 1.7;
            padding: 0.5rem;
            color: #d1d5db; /* gray-300 */
        }

    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- شاشة تحميل بسيطة -->
    <div id="loader">
        <div class="spinner"></div>
    </div>
    
    <!-- رسالة التنبيه (Toast) -->
    <div id="toast">تم تسجيل التمرين بنجاح!</div>

    <!-- (جديد) نافذة الـ Modal الخاصة بنصائح Gemini -->
    <div id="ai-modal" class="hidden">
        <div class="card p-5">
            <div class="flex justify-between items-center mb-4">
                <h3 id="ai-modal-title" class="text-xl font-semibold text-purple-400">✨ نصائح الذكاء الاصطناعي</h3>
                <button id="ai-modal-close" class="text-gray-400 hover:text-white">
                    <ion-icon name="close-outline" class="text-3xl"></ion-icon>
                </button>
            </div>
            <div id="ai-modal-content" class="text-gray-300">
                <!-- السبينر أو المحتوى سيظهر هنا -->
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- حاوية التطبيق الرئيسية (ظاهرة دائماً) -->
    <div id="app-container" class="max-w-7xl mx-auto">
        <!-- الهيدر -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 pb-4 border-b border-gray-700">
            <!-- (تعديل) معلومات ثابتة -->
            <div class="flex items-center gap-4 mb-4 sm:mb-0">
                <!-- (تعديل) أيقونة التمرين -->
                <div class="flex-shrink-0 w-14 h-14 flex items-center justify-center rounded-full bg-gray-800 border-2 border-blue-600 shadow-lg">
                    <ion-icon name="barbell-outline" class="text-blue-400 text-4xl"></ion-icon>
                </div>
                <div>
                    <!-- (تعديل) الاسم بالإنجليزية -->
                    <h1 class="text-2xl sm:text-3xl font-bold text-white">Omar Abdelbaki</h1>
                    <p id="profile-name" class="text-sm text-gray-400">مرحباً بك!</p>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- العمود الأيسر: جدول التمارين -->
            <div class="lg:col-span-2">
                <div class="card">
                    <div class="p-5">
                        <h2 class="text-2xl font-semibold mb-4 text-white">تسجيل التمارين</h2>
                        <!-- أزرار التبويب (Tabs) -->
                        <div id="tab-buttons" class="flex flex-wrap gap-2 mb-4">
                            <!-- سيتم إنشاؤها بـ JS -->
                        </div>
                        
                        <!-- محتوى التبويب (التمارين) -->
                        <div id="tab-content" class="space-y-4">
                            <!-- سيتم إنشاؤه بـ JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- العمود الأيمن: مؤشر التطور -->
            <div class="lg:col-span-1 space-y-6">
                <div class="card">
                    <div class="p-5">
                        <h2 class="text-2xl font-semibold mb-4 text-white">مؤشر التطور</h2>
                        <div class="mb-4">
                            <label for="chartExerciseSelect" class="block text-sm font-medium text-gray-300 mb-2">اختر تمرينًا لعرض تطوره:</label>
                            <select id="chartExerciseSelect" class="w-full form-input bg-gray-700 border-gray-600 text-white p-2 rounded-md">
                                <!-- سيتم إنشاؤه بـ JS -->
                            </select>
                        </div>
                        <div>
                            <canvas id="progressChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- سجل آخر التمارين -->
                <div class="card">
                    <div class="p-5">
                        <h2 class="text-2xl font-semibold mb-4 text-white">سجل التمارين</h2>
                        <ul id="logHistory" class="space-y-3 h-64 overflow-y-auto pr-2">
                            <!-- سيتم إنشاؤه بـ JS -->
                            <li id="historyLoader" class="text-gray-400 text-center">جاري تحميل السجل...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- (جديد) إعدادات Gemini API ---
        const apiKey = "AIzaSyBl7jGtYIEPyl16mi9wP93ntaktDLrhil0"; // اتركها فارغة، ستوفرها البيئة
        // --- (إصلاح) تصحيح الخطأ الإملائي في الرابط ---
        const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // --- المتغيرات العامة ---
        let myChart;
        const STORAGE_KEY = 'omarWorkoutLogs_v1';
        let allLogsCache = []; // كاش لتخزين كل السجلات

        // عناصر الواجهة
        const loader = document.getElementById('loader');
        const appContainer = document.getElementById('app-container');
        const tabButtonsContainer = document.getElementById('tab-buttons');
        const tabContentContainer = document.getElementById('tab-content');
        const chartExerciseSelect = document.getElementById('chartExerciseSelect');
        const historyList = document.getElementById('logHistory');
        const historyLoader = document.getElementById('historyLoader');
        const toast = document.getElementById('toast');
        const ctx = document.getElementById('progressChart').getContext('2d');
        
        // (جديد) عناصر الـ Modal
        const aiModal = document.getElementById('ai-modal');
        const aiModalTitle = document.getElementById('ai-modal-title');
        const aiModalContent = document.getElementById('ai-modal-content');
        const aiModalClose = document.getElementById('ai-modal-close');

        // --- هيكل بيانات التمرين (نفسه) ---
        const workoutPlan = [
            // ... (نفس خطة التمرين بدون تغيير) ...
            {
                day: "اليوم الأول: سكوات ثقيل",
                exercises: [
                    { name: "سكوات خلفي (Back Squat)", sets: "5x5" },
                    { name: "سكوات أمامي (Front Squat)", sets: "3x8-10" },
                    { name: "مرجحة أرجل خلفية بالدامبل (Dumbbell RDL)", sets: "3x10-12" },
                    { name: "مرجحة أرجل أمامية (Leg Extensions)", sets: "3x12-15" },
                    { name: "بطات (Calf Raises)", sets: "4x15" }
                ]
            },
            {
                day: "اليوم الثاني: بنش ثقيل",
                exercises: [
                    { name: "بنش بريس (Barbell Bench Press)", sets: "5x5" },
                    { name: "بنش بريس مائل بالدامبل (Incline DB Press)", sets: "3x8-10" },
                    { name: "بنش بريس سفلي بالدامبل (Decline DB Press)", sets: "3x8-10" },
                    { name: "ترايسبس بوش داون (Triceps Pushdown)", sets: "3x12-15" },
                    { name: "رفرفة جانبية (Lateral Raises)", sets: "4x12-15" }
                ]
            },
            {
                day: "اليوم الثالث: ديدليفت ثقيل",
                exercises: [
                    { name: "ديدليفت (Conventional/Sumo) - Top Set", sets: "1x3-5" },
                    // --- (إصلاح) تم حذف السطر المكرر والم خاطئ من هنا ---
                    { name: "ديدليفت (Back-off sets)", sets: "2-3x5" },
                    { name: "عقله (Pull-ups) / سحب علوي (Lat Pulldown)", sets: "4x6-10" },
                    { name: "تجديف بالبار (Barbell Row)", sets: "4x8-10" },
                    { name: "بايسبس كيرل بالبار (Barbell Curls)", sets: "3x10-12" }
                ]
            },
            {
                day: "اليوم الرابع: بنش (حجم/سرعة)",
                exercises: [
                    { name: "بنش بريس (Bench Press) - حجم", sets: "4x8-10" },
                    { name: "دفع كتف علوي بالبار (Overhead Press)", sets: "4x6-8" },
                    { name: "بنش بريس قبضة ضيقة (Close Grip BP)", sets: "3x8-10" },
                    { name: "رفرفة أمامية + جانبية", sets: "3x12" },
                    { name: "ترايسبس (Overhead Triceps Extension)", sets: "3x12-15" }
                ]
            },
            {
                day: "اليوم الخامس: سكوات (حجم/تكنيك)",
                exercises: [
                    { name: "سكوات (Back Squat) - حجم", sets: "4x8-10" },
                    { name: "ديدليفت روماني (RDL)", sets: "3x10-12" },
                    { name: "مرجحة أرجل خلفية (Lying Leg Curls)", sets: "3x12-15" },
                    { name: "تجديف خفيف (Cable Rows)", sets: "3x12-15" }
                ]
            }
        ];
        
        // --- (جديد) دوال Gemini API ---

        // دالة لإعادة المحاولة عند فشل الاتصال
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            let delay = 1000; // 1 second
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    // لا تسجل أخطاء 429 (Rate Limit) في الكونسول
                    if (response.status !== 429) {
                         console.warn(`API request failed with status ${response.status}. Retrying in ${delay}ms...`);
                    }
                } catch (error) {
                    // لا تسجل أخطياء الشبكة العادية في الكونسول
                    // console.warn(`Fetch error: ${error.message}. Retrying in ${delay}ms...`);
                }
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2; // Exponential backoff
            }
            throw new Error("Failed to fetch from Gemini API after multiple retries.");
        }

        // دالة استدعاء Gemini الرئيسية
        async function callGeminiApi(prompt) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            
            console.log("Calling Gemini API...");

            try {
                const response = await fetchWithBackoff(geminiApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("Gemini API Error Response:", errorBody);
                    throw new Error(`Gemini API request failed with status ${response.status}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    
                    const text = result.candidates[0].content.parts[0].text;
                    console.log("Gemini API Success.");
                    return text;
                } else {
                    console.warn("Unexpected Gemini API response structure:", result);
                    throw new Error("لم يتم العثور على محتوى في رد الـ API.");
                }
            } catch (error) {
                console.error("Error in callGeminiApi:", error);
                throw error;
            }
        }

        // (جديد) دالة للحصول على نصائح الأداء
        async function handleAiTips(exerciseName) {
            aiModalTitle.textContent = `✨ نصائح لـ ${exerciseName}`;
            aiModalContent.innerHTML = '<div class="spinner"></div>';
            aiModal.classList.remove('hidden');

            const prompt = `أنت مدرب لياقة بدنية خبير.
قدم 3 نصائح أساسية ومختصرة (كنقاط) باللغة العربية لتحسين الأداء الصحيح لتمرين: "${exerciseName}".`;

            try {
                const resultText = await callGeminiApi(prompt);
                aiModalContent.textContent = resultText;
            } catch (error) {
                aiModalContent.innerHTML = `<p class="text-red-400 text-center">حدث خطأ أثناء جلب النصائح. الرجاء المحاولة لاحقاً.</p>`;
                showToast("خطأ: فشل في الحصول على نصائح.", true);
            }
        }

        // (جديد) دالة للحصول على اقتراح إحماء
        async function handleAiWarmup(dayName, exercises) {
            aiModalTitle.textContent = `✨ إحماء لـ ${dayName}`;
            aiModalContent.innerHTML = '<div class="spinner"></div>';
            aiModal.classList.remove('hidden');

            const prompt = `أنت مدرب لياقة بدنية خبير.
اقترح روتين إحماء ديناميكي (dynamic warm-up) مدته 5 دقائق، باللغة العربية.
روتين الإحماء هذا هو لليوم التدريبي المسمى: "${dayName}"
الذي يحتوي على التمارين الأساسية التالية: ${exercises}.
اجعل الرد كنقاط واضحة ومختصرة.`;

            try {
                const resultText = await callGeminiApi(prompt);
                aiModalContent.textContent = resultText;
            } catch (error) {
                aiModalContent.innerHTML = `<p class="text-red-400 text-center">حدث خطأ أثناء جلب الاقتراح. الرجاء المحاولة لاحقاً.</p>`;
                showToast("خطأ: فشل في الحصول على اقتراح.", true);
            }
        }


        // --- دوال localStorage ---
        function getLogsFromStorage() {
            try {
                const logs = localStorage.getItem(STORAGE_KEY);
                return logs ? JSON.parse(logs) : [];
            } catch (error) {
                console.error("Error reading from localStorage:", error);
                return [];
            }
        }

        function saveLogsToStorage(logs) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
            } catch (error)
            {
                console.error("Error saving to localStorage:", error);
                showToast("خطأ: فشل حفظ البيانات. قد تكون الذاكرة ممتلئة.", true);
            }
        }
        
        // --- 2. بدء تشغيل التطبيق ---
        function initApp() {
            setupAppUI();
            loadInitialData(); // تحميل البيانات من localStorage
            setupModalListeners(); // (جديد)
            
            // إخفاء اللودر
            setTimeout(() => {
                loader.style.opacity = '0';
                setTimeout(() => loader.classList.add('hidden'), 500); // إخفاء بعد انتهاء التلاشي
            }, 300); // 0.3 ثانية
        }

        // --- 3. إعداد واجهة المستخدم (تعديل: إضافة أزرار Gemini) ---
        function setupAppUI() {
            tabButtonsContainer.innerHTML = '';
            tabContentContainer.innerHTML = '';
            let uniqueExercises = new Set();

            workoutPlan.forEach((dayPlan, dayIndex) => {
                const tabButton = document.createElement('button');
                tabButton.className = `tab-button ${dayIndex === 0 ? 'active' : ''}`;
                tabButton.textContent = dayPlan.day;
                tabButton.dataset.tab = `day-${dayIndex}`;
                tabButtonsContainer.appendChild(tabButton);

                const tabContent = document.createElement('div');
                tabContent.id = `day-${dayIndex}`;
                tabContent.className = `tab-content ${dayIndex === 0 ? 'active' : ''} space-y-4 card bg-gray-900 p-4 border border-gray-700 rounded-lg`;
                
                // (جديد) إضافة زر الإحماء
                const warmUpBtn = document.createElement('button');
                warmUpBtn.className = 'ai-warmup-btn';
                warmUpBtn.innerHTML = `✨ اقتراح إحماء لهذا اليوم`;
                warmUpBtn.dataset.dayName = dayPlan.day;
                warmUpBtn.dataset.exercises = dayPlan.exercises.map(e => e.name).join(', ');
                tabContent.appendChild(warmUpBtn);

                // (جديد) إضافة فاصل
                const divider = document.createElement('hr');
                divider.className = 'border-gray-700 my-4';
                tabContent.appendChild(divider);


                dayPlan.exercises.forEach((exercise, exIndex) => {
                    uniqueExercises.add(exercise.name); 

                    const exItem = document.createElement('div');
                    exItem.className = 'exercise-item flex flex-col sm:flex-row justify-between items-center gap-3 p-3 bg-gray-800 rounded-md border border-gray-700';
                    
                    // (تعديل) إضافة زر نصائح Gemini
                    exItem.innerHTML = `
                        <div class="flex-1 text-center sm:text-right">
                            <p class="font-semibold text-white">${exercise.name}</p>
                            <p class="text-sm text-gray-400">${exercise.sets}</p>
                        </div>
                        <div class="flex gap-2 items-center flex-wrap justify-center sm:justify-end">
                            <input type="number" id="weight-d${dayIndex}-e${exIndex}" class="form-input" placeholder="الوزن">
                            <input type="number" id="reps-d${dayIndex}-e${exIndex}" class="form-input" placeholder="التكرار">
                            <button class="log-button" data-day-index="${dayIndex}" data-ex-index="${exIndex}">
                                <ion-icon name="checkmark-circle-outline" class="text-xl"></ion-icon>
                            </button>
                            <!-- (جديد) زر نصائح الأداء -->
                            <button type="button" class="ai-tips-btn" data-ex-name="${exercise.name}">
                                ✨ نصائح
                            </button>
                        </div>
                    `;
                    tabContent.appendChild(exItem);
                });
                tabContentContainer.appendChild(tabContent);
            });
            
            chartExerciseSelect.innerHTML = '<option value="">-- اختر تمرينًا --</option>';
            uniqueExercises.forEach(exName => {
                const option = document.createElement('option');
                option.value = exName;
                option.textContent = exName;
                chartExerciseSelect.appendChild(option);
            });

            setupTabListeners();
            setupTabContentListeners(); // (تعديل) اسم الدالة
            setupChartSelectListener();
            setupHistoryDeleteListener();
        }

        // --- 4. إعداد مستمعي الأحداث ---
        function setupTabListeners() {
            tabButtonsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('tab-button')) {
                    tabButtonsContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    tabContentContainer.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    e.target.classList.add('active');
                    document.getElementById(e.target.dataset.tab).classList.add('active');
                }
            });
        }
        
        // (جديد)
        function setupModalListeners() {
            aiModalClose.addEventListener('click', () => {
                aiModal.classList.add('hidden');
            });
            // إغلاق عند الضغط خارج الكارت
            aiModal.addEventListener('click', (e) => {
                if (e.target === aiModal) {
                    aiModal.classList.add('hidden');
                }
            });
        }

        // (تعديل) اسم الدالة وإضافة مستمعي Gemini
        function setupTabContentListeners() {
            tabContentContainer.addEventListener('click', (e) => {
                const logButton = e.target.closest('.log-button');
                const tipsButton = e.target.closest('.ai-tips-btn');
                const warmUpButton = e.target.closest('.ai-warmup-btn');

                // --- منطق تسجيل التمرين ---
                if (logButton) {
                    const { dayIndex, exIndex } = logButton.dataset;
                    
                    const weightInput = document.getElementById(`weight-d${dayIndex}-e${exIndex}`);
                    const repsInput = document.getElementById(`reps-d${dayIndex}-e${exIndex}`);
                    
                    const weight = parseFloat(weightInput.value);
                    const reps = parseInt(repsInput.value);
                    const exName = workoutPlan[dayIndex].exercises[exIndex].name;

                    if (!weight || !reps || weight <= 0 || reps <= 0) { 
                        showToast("الرجاء إدخال وزن وتكرار صحيحين.", true);
                        return;
                    }
                    
                    const log = {
                        id: `log_${new Date().getTime()}_${Math.random()}`,
                        exerciseName: exName,
                        weight: weight,
                        reps: reps,
                        timestamp: new Date().toISOString()
                    };

                    try {
                        allLogsCache.push(log); 
                        saveLogsToStorage(allLogsCache); 
                        showToast("تم تسجيل التمرين بنجاح!");
                        weightInput.value = '';
                        repsInput.value = '';
                        refreshData();
                    } catch (error) {
                        console.error("Error logging workout to localStorage: ", error);
                        showToast("حدث خطأ أثناء تسجيل التمرين.", true);
                    }
                }
                
                // --- (جديد) منطق نصائح الأداء ---
                if (tipsButton) {
                    const exName = tipsButton.dataset.exName;
                    handleAiTips(exName);
                }
                
                // --- (جديد) منطق اقتراح الإحماء ---
                if (warmUpButton) {
                    const dayName = warmUpButton.dataset.dayName;
                    const exercises = warmUpButton.dataset.exercises;
                    handleAiWarmup(dayName, exercises);
                }
            });
        }
        
        function setupHistoryDeleteListener() {
            historyList.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-log-btn');
                if (deleteBtn) {
                    const logId = deleteBtn.dataset.id;
                    if (!logId) return;

                    showToast("جاري حذف السجل...");
                    try {
                        allLogsCache = allLogsCache.filter(log => log.id !== logId);
                        saveLogsToStorage(allLogsCache);
                        showToast("تم حذف السجل بنجاح.");
                        refreshData(); // تحديث الواجهة
                    } catch (error) {
                        console.error("Error deleting log:", error);
                        showToast("خطأ أثناء حذف السجل.", true);
                    }
                }
            });
        }

        function setupChartSelectListener() {
            chartExerciseSelect.addEventListener('change', (e) => {
                const selectedExercise = e.target.value;
                updateChartData(selectedExercise); 
            });
        }

        // --- 5. تحميل البيانات ---
        function loadInitialData() {
            allLogsCache = getLogsFromStorage();
            console.log("Loaded logs from storage:", allLogsCache.length);
            refreshData();
        }
        
        function refreshData() {
             // فرز البيانات (الأحدث أولاً للسجل)
            allLogsCache.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            updateHistoryList(allLogsCache.slice(0, 10));

            const selectedExercise = chartExerciseSelect.value;
            if (selectedExercise) {
                updateChartData(selectedExercise);
            } else {
                if (myChart) myChart.destroy(); 
            }
        }

        
        // --- 6. تحديث الرسم البياني ---
        function updateChartData(exerciseName) {
            if (!exerciseName) {
                if (myChart) myChart.destroy();
                return;
            }
            
            const exerciseLogs = allLogsCache.filter(log => log.exerciseName === exerciseName);
            exerciseLogs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); 

            const labels = exerciseLogs.map(log => new Date(log.timestamp).toLocaleDateString('ar-EG', { day: '2-digit', month: 'short' }));
            const weightData = exerciseLogs.map(log => log.weight);
            
            updateChart(labels, weightData, exerciseName);
        }

        function updateChart(labels, data, exerciseName) {
            if (myChart) {
                myChart.destroy(); 
            }
            
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `تطور الوزن (كجم) - ${exerciseName}`,
                        data: data,
                        fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)', 
                        borderColor: '#3b82f6', 
                        tension: 0.1,
                        pointBackgroundColor: '#3b82f6',
                        pointRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: { color: '#9ca3af' }, 
                            grid: { color: '#374151' } 
                        },
                        x: {
                            ticks: { color: '#9ca3af' }, 
                            grid: { color: '#374151' } 
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#d1d5db' } 
                        }
                    }
                }
            });
        }
        
        // --- 7. تحديث قائمة السجل ---
        function updateHistoryList(logs) {
            historyList.innerHTML = ''; 
            if (logs.length === 0) {
                historyList.innerHTML = '<li class="text-gray-400 text-center">لم يتم تسجيل أي تمارين بعد.</li>';
                return;
            }

            logs.forEach(log => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-gray-800 p-2 rounded-md border border-gray-700';
                
                const dateString = new Date(log.timestamp).toLocaleString('ar-EG');
                
                li.innerHTML = `
                    <div class="flex-1">
                        <p class="font-medium text-white">${log.exerciseName}</p>
                        <p class="text-sm text-gray-400">${dateString}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-blue-400">${log.weight} كجم</p>
                        <p class="text-sm text-gray-300">${log.reps} تكرار</p>
                    </div>
                    <button class="delete-log-btn text-red-500 hover:text-red-400 ml-4" data-id="${log.id}">
                        <ion-icon name="trash-outline" class="text-xl"></ion-icon>
                    </button>
                `;
                historyList.appendChild(li);
            });
        }

        // --- 8. وظائف مساعدة ---
        function showToast(message, isError = false) {
            toast.textContent = message;
            toast.style.backgroundColor = isError ? '#ef4444' : '#16a34a'; // أحمر أو أخضر
            toast.style.bottom = '20px'; 
            
            setTimeout(() => {
                toast.style.bottom = '-100px'; 
            }, 3000); 
        }

        // --- بدء تشغيل التطبيق ---
        window.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>